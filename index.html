<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang xử lý thanh toán | LamThangPhat Pay</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h2 { color: #333; margin-bottom: 10px; font-size: 20px; }
        p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .error-box { color: #d9534f; background: #f9d6d5; padding: 10px; border-radius: 8px; display: none; font-size: 13px; margin-top: 15px; }
        .btn-retry { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="loader" id="spinner"></div>
    <h2 id="statusTitle">Đang kết nối cổng thanh toán...</h2>
    <p id="statusDesc">Vui lòng không tắt trình duyệt, hệ thống đang tạo giao dịch an toàn.</p>
    
    <div id="errorBox" class="error-box"></div>
    <button id="retryBtn" class="btn-retry" onclick="location.reload()">Thử lại</button>
</div>

<script>
    // Link Server Tổng của bạn (Tôi đã giữ nguyên link bạn cung cấp)
    const GATEWAY_URL = "https://script.google.com/macros/s/AKfycbxx9KT84my36bzSGKdLrgXWhL_kX0X7YFtBlU_VCP3NUVaytDo0cno919NDeY77mg26/exec";

    // Tự động chạy khi trang web tải xong
    window.onload = function() {
        processPayment();
    };

    async function processPayment() {
        const params = new URLSearchParams(window.location.search);
        const amount = params.get('amt');
        const note = params.get('note');
        const clientUrl = params.get('callback');

        if (!amount || !clientUrl) {
            showError("Thiếu thông tin thanh toán (Số tiền hoặc Link trả về).");
            return;
        }

        try {
            // Gọi về Server Tổng để lấy dữ liệu tạo Form
            const response = await fetch(GATEWAY_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "REGISTER_ORDER",
                    amount: amount,
                    note: note,
                    client_url: clientUrl
                })
            });

            const data = await response.json();

            // --- ĐOẠN XỬ LÝ MỚI (FIX LỖI 404) ---
            // Kiểm tra xem server có trả về dữ liệu payment_data không
            if (data.success && data.payment_data) {
                document.getElementById('statusTitle').innerText = "Đang chuyển hướng...";
                
                // Gọi hàm tạo Form POST và gửi đi ngay lập tức
                postToSePay(data.payment_data.endpoint, data.payment_data.params);
                
            } else {
                throw new Error(data.error || "Không lấy được dữ liệu thanh toán");
            }

        } catch (err) {
            console.error(err);
            showError("Lỗi kết nối máy chủ: " + err.message);
        }
    }

    // --- HÀM MỚI: TẠO FORM ẨN VÀ POST SANG SEPAY ---
    function postToSePay(endpoint, params) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = endpoint;
        
        // Tạo các thẻ input ẩn cho từng tham số
        for (const key in params) {
            if (params.hasOwnProperty(key)) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = key;
                hiddenField.value = params[key];
                form.appendChild(hiddenField);
            }
        }

        document.body.appendChild(form);
        form.submit(); // Tự động bấm nút gửi
    }

    function showError(msg) {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('statusTitle').innerText = "Đã xảy ra lỗi";
        document.getElementById('statusDesc').style.display = 'none';
        const box = document.getElementById('errorBox');
        box.innerText = msg;
        box.style.display = 'block';
        document.getElementById('retryBtn').style.display = 'inline-block';
    }
</script>

</body>
</html>
