<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Thanh toán Trực tuyến MedS Pay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        :root { --brand: #1c66da; --brand-light: #eff6ff; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .rounded-fin { border-radius: 16px; }
        .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); }
        .copy-tooltip { display: none; position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: #111827; color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; z-index: 50; }
        .scan-line { height: 2px; background: linear-gradient(to right, transparent, var(--brand), transparent); position: absolute; width: 100%; z-index: 10; animation: scan 3s linear infinite; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        /* Style cho QnA */
        .qna-card { transition: all 0.3s ease; border: 1px solid #f1f5f9; }
        .qna-card:hover { border-color: #1c66da; background-color: #ffffff; transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased text-slate-900">

    <header class="w-full glass-header border-b border-slate-100 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-[#1c66da] rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-100">
                    <i class="fa-solid fa-shield-check text-lg"></i>
                </div>
                <div>
                    <h1 class="text-sm font-extrabold tracking-tight leading-none uppercase">MedS <span class="text-[#1c66da]">Pay</span></h1>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Cổng thanh toán trực tuyến</p>
                </div>
            </div>
            <div class="flex items-center gap-1.5 text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100">
                <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                <span class="text-[10px] font-black uppercase tracking-wider">Bảo mật SSL</span>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 md:py-16">
        <div id="mainCard" class="max-w-sm mx-auto bg-white rounded-fin shadow-xl p-16 text-center border border-slate-50">
            <div class="w-10 h-10 border-4 border-slate-100 border-t-[#1c66da] rounded-full animate-spin mx-auto mb-6"></div>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Khởi tạo giao dịch...</p>
        </div>

        <div id="paymentModal" class="hidden max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-5 space-y-6">
                <div class="bg-white rounded-fin p-8 shadow-xl shadow-blue-900/5 border border-slate-50 relative overflow-hidden text-center">
                    <span class="inline-block bg-blue-50 text-[#1c66da] px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.1em] mb-6 border border-blue-100">VietQR (Napas 247)</span>
                    
                    <div class="relative bg-slate-50 p-4 rounded-xl border border-slate-100 mx-auto w-fit">
                        <div class="scan-line"></div>
                        <img id="qrImg" src="" class="w-64 h-64 lg:w-72 lg:h-72 object-contain mix-blend-multiply" alt="QR Payment">
                        <div id="qrOverlaySuccess" class="hidden absolute inset-0 bg-white/95 backdrop-blur-md rounded-xl flex flex-col items-center justify-center z-20 border-2 border-emerald-500">
                            <div class="w-16 h-16 bg-emerald-500 rounded-full flex items-center justify-center text-white text-3xl mb-4 shadow-xl shadow-emerald-100 animate-bounce">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <span class="font-black text-emerald-600 uppercase tracking-widest text-sm">Thanh toán hoàn tất</span>
                        </div>
                    </div>

                    <div class="mt-8 flex items-center justify-center gap-3 py-4 px-4 bg-blue-50/50 rounded-xl border border-blue-100">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#1c66da] opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-[#1c66da]"></span>
                        </span>
                        <span class="text-slate-600 text-[11px] font-black uppercase tracking-widest">Đang chờ xác nhận...</span>
                    </div>

                    <div class="md:hidden mt-6">
                        <a href="https://dl.vietqr.io/pay?app=mbbank" class="w-full flex items-center justify-center gap-3 bg-[#1c66da] text-white py-4 rounded-xl font-bold text-sm shadow-lg shadow-blue-200">
                            <i class="fa-solid fa-mobile-screen"></i> Mở ứng dụng Ngân hàng
                        </a>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7 space-y-6">
                <div class="bg-white rounded-fin shadow-xl shadow-blue-900/5 border border-slate-50 overflow-hidden">
                    <div class="p-8 border-b border-slate-50 flex justify-between items-center">
                        <h2 class="text-lg font-black text-slate-800 tracking-tight uppercase italic">Thông tin chuyển khoản</h2>
                        <span id="badgePending" class="flex items-center gap-2 px-3 py-1 bg-amber-50 text-amber-600 rounded-full text-[9px] font-black uppercase border border-amber-100">
                            Chờ xác nhận
                        </span>
                    </div>

                    <div class="p-8 space-y-6">
                        <div class="group relative bg-blue-50/50 p-6 rounded-xl border border-blue-100 cursor-pointer transition-all active:scale-[0.98]" onclick="copyText(paymentData.amt, 'amt')">
                            <p class="text-[10px] font-black uppercase mb-1 tracking-widest italic text-blue-400">Giá trị thanh toán</p>
                            <div class="flex justify-between items-center">
                                <p id="qrAmountDisplay" class="text-4xl font-black text-[#1c66da] tracking-tighter">0đ</p>
                                <i class="fa-regular fa-copy text-blue-300 group-hover:text-[#1c66da]"></i>
                            </div>
                            <span id="tip-amt" class="copy-tooltip">Đã chép số tiền</span>
                        </div>

                        <div class="group relative bg-amber-50/50 p-6 rounded-xl border-2 border-dashed border-amber-200 cursor-pointer transition-all active:scale-[0.98]" onclick="copyText(paymentData.note, 'note')">
                            <p class="text-[10px] font-black text-amber-600 uppercase mb-2 tracking-[0.2em] italic text-center">Nội dung giao dịch (Cần chính xác)</p>
                            <p id="qrNoteDisplay" class="text-4xl font-black text-slate-800 tracking-[0.1em] uppercase text-center">---</p>
                            <span id="tip-note" class="copy-tooltip bg-amber-600">Đã chép nội dung</span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="group relative p-4 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-[#1c66da]" onclick="copyText(paymentData.stk, 'stk')">
                                <p id="bankDisplay" class="text-[9px] font-black text-slate-400 uppercase mb-1">Số tài khoản</p>
                                <p id="targetSTK" class="font-black text-slate-700">---</p>
                                <span id="tip-stk" class="copy-tooltip">Đã chép STK</span>
                            </div>
                            <div class="group relative p-4 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-[#1c66da]" onclick="copyText(paymentData.name, 'name')">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Đơn vị thụ hưởng</p>
                                <p id="targetName" class="font-black text-slate-700 uppercase italic text-xs">---</p>
                                <span id="tip-name" class="copy-tooltip">Đã chép tên</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="qna-card p-5 bg-white rounded-xl shadow-sm">
                        <h4 class="text-[11px] font-black text-[#1c66da] uppercase mb-2 italic tracking-wider">Chưa nhận được xác nhận?</h4>
                        <p class="text-[10px] text-slate-500 leading-relaxed font-medium">Giao dịch thường mất 1-3 phút để đồng bộ. Vui lòng không tắt màn hình này cho đến khi nhận được thông báo thành công.</p>
                    </div>
                    <div class="qna-card p-5 bg-white rounded-xl shadow-sm">
                        <h4 class="text-[11px] font-black text-[#1c66da] uppercase mb-2 italic tracking-wider">Lỡ nhập sai nội dung?</h4>
                        <p class="text-[10px] text-slate-500 leading-relaxed font-medium">Đừng lo lắng! Hãy chụp lại màn hình biên lai ngân hàng và gửi ngay cho chúng tôi qua số điện thoại hỗ trợ phía dưới.</p>
                    </div>
                    <div class="qna-card p-5 bg-white rounded-xl shadow-sm">
                        <h4 class="text-[11px] font-black text-[#1c66da] uppercase mb-2 italic tracking-wider">Kích hoạt dịch vụ</h4>
                        <p class="text-[10px] text-slate-500 leading-relaxed font-medium">Ngay sau khi hệ thống báo "Thành công", tài khoản MedS của bạn sẽ được kích hoạt/gia hạn hoàn toàn tự động.</p>
                    </div>
                    <div class="qna-card p-5 bg-white rounded-xl shadow-sm">
                        <h4 class="text-[11px] font-black text-[#1c66da] uppercase mb-2 italic tracking-wider">Yêu cầu hóa đơn VAT?</h4>
                        <p class="text-[10px] text-slate-500 leading-relaxed font-medium">Quý đối tác cần xuất hóa đơn tài chính, vui lòng liên hệ bộ phận Kế toán của Lâm Thắng Phát trong vòng 24h.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full bg-slate-900 pt-20 pb-10 px-6 text-slate-500">
        <div class="max-w-5xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-12 border-b border-slate-800 pb-16">
                <div class="md:col-span-6">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-8 h-8 bg-[#1c66da] rounded-lg flex items-center justify-center text-white">
                            <i class="fa-solid fa-shield-keyhole"></i>
                        </div>
                        <h4 class="text-white font-black text-sm uppercase tracking-tight italic">MedS Pay <span class="text-[#1c66da]">System</span></h4>
                    </div>
                    <p class="text-[11px] font-black text-slate-300 uppercase tracking-widest mb-3 italic">CÔNG TY TNHH THƯƠNG MẠI VÀ DỊCH VỤ LÂM THẮNG PHÁT</p>
                    <div class="space-y-2 text-[11px] font-bold uppercase tracking-widest opacity-50">
                        <p>MST: 4001299968</p>
                        <p>Địa chỉ: Tam Hòa, xã Hà Nha, TP Đà Nẵng</p>
                    </div>
                </div>
                
                <div class="md:col-span-6 md:text-right flex flex-col items-start md:items-end">
                    <h5 class="text-white font-black text-[10px] uppercase tracking-[0.2em] mb-8 opacity-40">Hỗ trợ kỹ thuật 24/7</h5>
                    <a href="tel:0345056117" class="inline-block bg-[#1c66da] text-white px-8 py-4 rounded-xl font-black text-xl shadow-2xl shadow-blue-900/40 hover:bg-blue-600 transition-all">
                        <i class="fa-solid fa-headset mr-3 text-sm"></i>0345.056.117
                    </a>
                </div>
            </div>
            
            <div class="mt-10 flex flex-col md:flex-row justify-between items-center gap-6 text-[10px] font-black uppercase tracking-[0.2em] opacity-20 italic">
                <p>&copy; 2026 MEDS SYSTEM. PCI DSS COMPLIANT PLATFORM.</p>
                <div class="flex items-center space-x-8">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-lock-keyhole"></i> SSL SECURE</span>
                    <span class="flex items-center gap-2"><i class="fa-solid fa-bolt-auto"></i> AUTO INSTANT</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const GATEWAY_URL = "https://script.google.com/macros/s/AKfycbxx9KT84my36bzSGKdLrgXWhL_kX0X7YFtBlU_VCP3NUVaytDo0cno919NDeY77mg26/exec";
        let checkInterval = null;
        let paymentData = { amt: 0, stk: "", name: "", note: "" };

        window.onload = processPayment;

        async function processPayment() {
            const params = new URLSearchParams(window.location.search);
            const packageId = params.get('package'); 
            const clientUrl = params.get('callback');

            if (!packageId) {
                showError("Vui lòng xác định dịch vụ đăng ký.");
                return;
            }

            try {
                const response = await fetch(GATEWAY_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "REGISTER_ORDER", package_id: packageId, client_url: clientUrl })
                });

                const data = await response.json();

                if (data.success) {
                    paymentData.amt = data.amount;
                    paymentData.stk = data.account_no;
                    paymentData.name = data.account_name;
                    paymentData.note = data.order_id;
                    const bankId = data.bank_id || "970422";
                    const bankName = data.bank_name || "MBBank";

                    const qrUrl = `https://img.vietqr.io/image/${bankId}-${paymentData.stk}-print.png?amount=${paymentData.amt}&addInfo=${paymentData.note}&accountName=${encodeURIComponent(paymentData.name)}`;
                    
                    document.getElementById('qrImg').src = qrUrl;
                    document.getElementById('qrAmountDisplay').innerText = parseInt(paymentData.amt).toLocaleString() + "đ";
                    document.getElementById('qrNoteDisplay').innerText = paymentData.note;
                    document.getElementById('targetName').innerText = paymentData.name;
                    document.getElementById('targetSTK').innerText = paymentData.stk;
                    document.getElementById('bankDisplay').innerText = `STK (${bankName})`;

                    document.getElementById('paymentModal').classList.remove('hidden');
                    document.getElementById('paymentModal').classList.add('grid');
                    document.getElementById('mainCard').classList.add('hidden');

                    startPolling(paymentData.note);
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                showError("Lỗi hệ thống: " + err.message);
            }
        }

        function startPolling(orderId) {
            checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${GATEWAY_URL}?action=CHECK_STATUS&order_id=${orderId}&nocache=${new Date().getTime()}`);
                    const status = await response.json();
                    if (status.isSuccess === true || String(status.isSuccess) === "true") {
                        clearInterval(checkInterval);
                        showSuccessUI();
                    }
                } catch (e) { console.warn("Polling..."); }
            }, 3000);
        }

        function showSuccessUI() {
            document.getElementById('badgePending').classList.add('hidden');
            document.getElementById('badgeSuccess').classList.remove('hidden');
            document.getElementById('qrOverlaySuccess').classList.remove('hidden');
            document.getElementById('qrOverlaySuccess').classList.add('flex');
            
            setTimeout(() => {
                const callback = new URLSearchParams(window.location.search).get('callback');
                if (callback) window.location.href = callback;
                else alert("Xác nhận thanh toán thành công!");
            }, 3000);
        }

        function copyText(text, id) {
            navigator.clipboard.writeText(text).then(() => {
                const tooltip = document.getElementById('tip-' + id);
                tooltip.style.display = 'block';
                setTimeout(() => { tooltip.style.display = 'none'; }, 1500);
            });
        }

        function showError(msg) {
            document.getElementById('mainCard').classList.remove('hidden');
            const box = document.getElementById('errorBox');
            box.innerText = msg; box.classList.remove('hidden');
        }
    </script>
</body>
</html>
