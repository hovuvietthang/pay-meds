<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n | LamThangPhat Pay</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; max-width: 380px; width: 90%; }
        
        /* Modal Styles */
        #paymentModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 9999; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 320px; text-align: center; position: relative; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .qr-code { width: 100%; border: 1px solid #eee; border-radius: 12px; margin: 15px 0; }
        .info-row { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: left; margin-bottom: 10px; font-size: 14px; }
        .info-row b { color: #007bff; float: right; }
        
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-top: 10px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-success { background: #d4edda; color: #155724; display: none; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-close { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #ccc; border: none; background: none; }
        .btn-close:hover { color: #333; }
        .error-box { color: #d9534f; background: #f9d6d5; padding: 10px; border-radius: 8px; display: none; font-size: 13px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card" id="mainCard">
    <div class="loader" id="spinner"></div>
    <h2 id="statusTitle">Kh·ªüi t·∫°o giao d·ªãch...</h2>
    <p id="statusDesc">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t ƒë·ªÉ h·ªá th·ªëng t·∫°o m√£ QR thanh to√°n.</p>
    <div id="errorBox" class="error-box"></div>
</div>

<div id="paymentModal">
    <div class="modal-box">
        <button class="btn-close" onclick="location.reload()">&times;</button>
        <h3 style="margin: 0 0 5px 0; font-size: 18px;">Thanh to√°n QR</h3>
        <div class="status-badge status-pending" id="badgePending">ƒêang ch·ªù chuy·ªÉn kho·∫£n...</div>
        <div class="status-badge status-success" id="badgeSuccess">‚úÖ Th√†nh c√¥ng!</div>
        
        <img id="qrImg" src="" class="qr-code" alt="M√£ QR Thanh to√°n">
        
        <div class="info-row">S·ªë ti·ªÅn: <b id="qrAmount">0ƒë</b></div>
        <div class="info-row">N·ªôi dung: <b id="qrNote">ƒêang t·∫£i...</b></div>
        
        <p style="font-size: 11px; color: #d9534f; margin-top: 10px;">
            * Vui l√≤ng qu√©t m√£ v√† <b>gi·ªØ nguy√™n n·ªôi dung</b> chuy·ªÉn kho·∫£n ƒë·ªÉ ƒë∆∞·ª£c duy·ªát t·ª± ƒë·ªông.
        </p>
    </div>
</div>

<script>
    // üî¥ KI·ªÇM TRA: ƒê·∫£m b·∫£o link n√†y l√† b·∫£n Deploy m·ªõi nh·∫•t c·ªßa Master DB (Anyone)
    const GATEWAY_URL = "https://script.google.com/macros/s/AKfycbxx9KT84my36bzSGKdLrgXWhL_kX0X7YFtBlU_VCP3NUVaytDo0cno919NDeY77mg26/exec";
    let checkInterval = null;

    window.onload = processPayment;

    async function processPayment() {
        const params = new URLSearchParams(window.location.search);
        
        // 1. L·∫§Y M√É G√ìI (Thay v√¨ l·∫•y s·ªë ti·ªÅn tr·ª±c ti·∫øp ƒë·ªÉ b·∫£o m·∫≠t)
        const packageId = params.get('package'); 
        const clientUrl = params.get('callback');

        if (!packageId) {
            showError("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin g√≥i thanh to√°n.");
            return;
        }

        try {
            // 2. G·ªçi sang Master DB ƒë·ªÉ ƒëƒÉng k√Ω v√† l·∫•y gi√° th·∫≠t
            const response = await fetch(GATEWAY_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "REGISTER_ORDER",
                    package_id: packageId,
                    client_url: clientUrl
                })
            });

            const data = await response.json();

            if (data.success) {
                const orderId = data.order_id;
                const realAmount = data.amount; // S·ªë ti·ªÅn th·∫≠t t·ª´ Master DB tra c·ª©u
                
                // 3. T·∫°o Link QR VietQR v·ªõi s·ªë ti·ªÅn th·∫≠t
                const qrUrl = `https://img.vietqr.io/image/MB-0345056117-compact.png?amount=${realAmount}&addInfo=${orderId}`;
                
                // 4. Hi·ªÉn th·ªã Popup
                document.getElementById('qrImg').src = qrUrl;
                document.getElementById('qrAmount').innerText = parseInt(realAmount).toLocaleString() + "ƒë";
                document.getElementById('qrNote').innerText = orderId;
                document.getElementById('paymentModal').style.display = 'flex';
                document.getElementById('mainCard').style.display = 'none';

                // 5. B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i t·ª± ƒë·ªông
                startPolling(orderId);
            } else {
                throw new Error(data.error || "G√≥i kh√¥ng t·ªìn t·∫°i tr√™n h·ªá th·ªëng.");
            }
        } catch (err) {
            showError("L·ªói k·∫øt n·ªëi: " + err.message);
        }
    }

    function startPolling(orderId) {
        checkInterval = setInterval(async () => {
            try {
                // Ki·ªÉm tra xem Master DB ƒë√£ ghi nh·∫≠n SUCCESS ch∆∞a
                const res = await fetch(`${GATEWAY_URL}?action=CHECK_STATUS&order_id=${orderId}`);
                const status = await res.json();

                if (status.isSuccess) {
                    clearInterval(checkInterval);
                    showSuccessUI();
                }
            } catch (e) {
                console.log("ƒêang ch·ªù thanh to√°n...");
            }
        }, 3000);
    }

    function showSuccessUI() {
        document.getElementById('badgePending').style.display = 'none';
        document.getElementById('badgeSuccess').style.display = 'inline-block';
        document.getElementById('qrImg').style.opacity = '0.3';
        
        setTimeout(() => {
            const params = new URLSearchParams(window.location.search);
            const callback = params.get('callback');
            if (callback) {
                // T·ª± ƒë·ªông quay v·ªÅ Client sau khi th√†nh c√¥ng
                window.location.href = callback; 
            } else {
                alert("Thanh to√°n th√†nh c√¥ng!");
            }
        }, 2000);
    }

    function showError(msg) {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('statusTitle').innerText = "Th·∫•t b·∫°i";
        document.getElementById('statusDesc').style.display = 'none';
        const box = document.getElementById('errorBox');
        box.innerText = msg;
        box.style.display = 'block';
    }
</script>

</body>
</html>
