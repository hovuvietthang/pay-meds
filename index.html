<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêang x·ª≠ l√Ω thanh to√°n | LamThangPhat Pay</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h2 { color: #333; margin-bottom: 10px; font-size: 20px; }
        p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .error-box { color: #d9534f; background: #f9d6d5; padding: 10px; border-radius: 8px; display: none; font-size: 13px; margin-top: 15px; }
        .btn-retry { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="loader" id="spinner"></div>
    <h2 id="statusTitle">ƒêang k·∫øt n·ªëi c·ªïng thanh to√°n...</h2>
    <p id="statusDesc">Vui l√≤ng kh√¥ng t·∫Øt tr√¨nh duy·ªát, h·ªá th·ªëng ƒëang t·∫°o giao d·ªãch an to√†n.</p>
    
    <div id="errorBox" class="error-box"></div>
    <button id="retryBtn" class="btn-retry" onclick="location.reload()">Th·ª≠ l·∫°i</button>
</div>

<script>
    // üî¥ THAY LINK SERVER T·ªîNG C·ª¶A B·∫†N V√ÄO ƒê√ÇY (Link Google Script ƒëu√¥i /exec)
    const GATEWAY_URL = "https://script.google.com/macros/s/AKfycbxx9KT84my36bzSGKdLrgXWhL_kX0X7YFtBlU_VCP3NUVaytDo0cno919NDeY77mg26/exec";

    // T·ª± ƒë·ªông ch·∫°y khi trang web t·∫£i xong
    window.onload = function() {
        processPayment();
    };

    async function processPayment() {
        // 1. L·∫•y th√¥ng tin t·ª´ URL (Do ph·∫ßn m·ªÅm con g·ª≠i sang)
        // V√≠ d·ª•: thanhtoan.lamthangphat.com/?amt=50000&note=MuaVip&callback=https://...
        const params = new URLSearchParams(window.location.search);
        const amount = params.get('amt');
        const note = params.get('note');
        const clientUrl = params.get('callback');

        // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
        if (!amount || !clientUrl) {
            showError("Thi·∫øu th√¥ng tin thanh to√°n (S·ªë ti·ªÅn ho·∫∑c Link tr·∫£ v·ªÅ).");
            return;
        }

        try {
            // 2. G·ªçi v·ªÅ Server T·ªïng ƒë·ªÉ ƒëƒÉng k√Ω ƒë∆°n h√†ng
            const response = await fetch(GATEWAY_URL, {
                method: "POST",
                // Google Script y√™u c·∫ßu mode no-cors ho·∫∑c redirect, nh∆∞ng ƒë·ªÉ l·∫•y JSON ta d√πng c√°ch chu·∫©n:
                // L∆∞u √Ω: C·∫ßn deploy Web App quy·ªÅn "Anyone" th√¨ m·ªõi fetch ƒë∆∞·ª£c
                body: JSON.stringify({
                    action: "REGISTER_ORDER",
                    amount: amount,
                    note: note,
                    client_url: clientUrl
                })
            });

            const data = await response.json();

            // 3. X·ª≠ l√Ω k·∫øt qu·∫£ tr·∫£ v·ªÅ
            if (data.success && data.url) {
                document.getElementById('statusTitle').innerText = "ƒêang chuy·ªÉn h∆∞·ªõng...";
                // Chuy·ªÉn kh√°ch sang SePay
                window.location.href = data.url;
            } else {
                throw new Error(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c link thanh to√°n");
            }

        } catch (err) {
            console.error(err);
            showError("L·ªói k·∫øt n·ªëi m√°y ch·ªß: " + err.message);
        }
    }

    function showError(msg) {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('statusTitle').innerText = "ƒê√£ x·∫£y ra l·ªói";
        document.getElementById('statusDesc').style.display = 'none';
        const box = document.getElementById('errorBox');
        box.innerText = msg;
        box.style.display = 'block';
        document.getElementById('retryBtn').style.display = 'inline-block';
    }
</script>

</body>
</html>
